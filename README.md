![Herple...](/hurple.png)
<!-- OldCord: bring back the past -->

# OldcordV3
Current code for Oldcord (Rewritten) in node.js. <br>
Contributions are welcome and encouraged. Please help clean/refactor up the existing codebase!

# Resources & External Contributors
ziad87 (Hummus2 private source code for token generation, permissions, sessions references, and some middleware references) <br>
discord.js (for snowflake) <br>
unkn0w (for disposable email domain list) <br>
Nebula Entertainment & Broadcasting LLC (for [Nebula Sans](https://nebulasans.com/) ‚Äî A drop in replacement for Whitney for the bootloader and build selector, which Discord used before 2022) <br>
[s074](https://github.com/spacebarchat/mediasoup-webrtc) and the spacebar team (Whole webrtc media server implementation with mediasoup)

# Important, read me!
Due to Oldcord's rapidly changing nature, there are some commits which may break your current database generated by the program. <br>
Which is why, on future commits where the DB is changed in a significant way, we will add a short SQL query/queries you can run to update the database to work with the new wrapper on the commit description. <br>
The server may also automatically run these migration scripts for you when you update your instance and restart it.<br>

There have been some major changes with Oldcord V3 recently, such as some pretty significant configuration file tweaks. <b>Make sure your config.json file ALWAYS matches the amount of entries in the example config whenever you pull from this repository.</b> <br><br>
Also, if you created your Oldcord instance before November 14 (2024) and you are updating it, please make sure that your `config.json` file is also updated to the new format, or your instance will not work. <br>

# FAQ
`What is WebRTC P2P?`
 - In the Jan 31st 2017 discord client build there was a new protocol for voice that was introduced, webrtc-p2p, it was around for at least the whole of 2017 & 2018, we don't know when it was removed - probably 2019 or so.
 - But we do know it was never actually used in the client, and there's no documentation on it ever existing, I assume it was there for discord developers to use on testing instances? It works by sending ICE candidates to the RTC server via OP 10, and the server just relays it out to the other clients in the call.
 - It is not recommended to use this feature without a VPN, as it does leak your IP address due to its nature of being <b>peer to peer</b>.

`Is Voice Supported?` <br><br>
[WebRTC-P2P](https://github.com/user-attachments/assets/0daf70dc-783e-4e97-a41c-829966d01254)<br>
[WebRTC](https://github.com/user-attachments/assets/98ffc6e3-f6fe-4d81-b57d-0d0465c374f0)<br>

 - Voice is still heavily work in progress! But it has been confirmed to be working, either via WebRTC P2P (Browser Client), UDP (Discord Client) or WebRTC (Browser Client).
 - There are some known bugs such as a subscriber/producer ssrc mismatch issue with the client, clients speaking without any indicator in calls, and you may need to re-join the call, deafen/undeafen to hear anything on receiving clients. We are working on a fix for this issue.
 - WebRTC does require the Modernize WebRTC SDP Truncation patch to be enabled to work!!

`How about Video? Is Video Supported?`
- Not at the moment, we're just trying to fix all the bugs with the clients & media server related to voice first.

`Does server muting/deafening work? And does deafening actually prevent you from receiving audio data?`
- Not right now but it's being actively worked on! As always, contributions are encouraged & welcome!

# Setup
Download and setup a postgreSQL server with the database name of your choice.
Download the `config.json` from the repository and modify the entries of your choice. Look below for a guide.

Run `npm install` to install all the packages required to run Oldcord and then `node server.js` to start Oldcord.

Since V3 is hosted on my own server at home, I use cloudflared to bypass CG-NAT and have enabled Cloudflare's free SSL so the SSL stuff in the earlier configuration is kinda deprecated.

`custom_invite_url` is used for invites in the app, putting "`example.com`" will make it so every invite made has the prefix [example.com](https://example.com) - much like [discord.gg](https://discord.gg), etc.

There are Google Recaptcha v2 demo site & secret keys in the config example which you may find useful to look at when looking to enable recaptcha on your instance. If you'd like to not have recaptcha enabled, just set `site_key` and `secret_key` to "" (blank). <br>
Also <b>it is highly recommended you change those values if you do plan on using Recaptcha on production. Since it's a demo site key, all answers are valid.</b>‚ö†Ô∏è

`integration_config` is for the in-app connections under user settings, currently only Twitch is supported, and you need to make a Twitch application which gives you a `client_secret` to use this.

Example integration configuration:
```
"integration_config" : [{
        "platform" : "twitch",
        "client_id" : "client_id",
        "client_secret" : "client_secret",
        "redirect_uri" : "https://staging.oldcordapp.com/api/connections/twitch/callback"
}]
```

`trusted_users` bypass short term rate-limits, use this to add specific users like bots from being blocked by the wacky rate-limits scattered across the project. <br>

`instance.flags` are kinda limited at the moment, but you can lock down an instance with these entries:

`NO_REGISTRATION` - Block all future users from creating an account on your instance. <br>
`NO_GUILD_CREATION` - Block future guilds from being created. <br>
`NO_INVITE_USE` - Block invites from being used. <br>

And you can also do some pretty cool stuff like:
`autojoin:GUILDID` (e.g autojoin:1413791197947867136) - Auto join a guild on account creation. <br>

More are to come with instance flags in the future. <br>

The `gcs_config` section of the `config.example.json` is for the ability to auto-upload saved assets from the wayback machine for future use later. <br>
It takes 2 properties, `autoUploadBucket` - which is the name of the bucket you want to automatically upload assets into, and `gcStorageFolder` (name of the folder within the bucket, i.e `assets`) <br>

Here's an example Google Cloud Storage configuration: 

```
"gcs_config" : {
   "autoUploadBucket" : "discord_assets_stuff",
   "gcStorageFolder" : "assets"
},
```

To setup Google Cloud Storage auto uploading, you need to download the Google Cloud SDK Shell and run these 2 commands to login and authorize your billing account for use in-applications:

```
gcloud auth login
gcloud auth application-default login
```

You <b>might</b> also need to configure CORS for your use of the bucket accordingly.

# Project Support Outline
üü¢ = Full Support <br>
üü† = Currently in development (or mostly supported, but not fully) <br>
üî¥ = Planned for development in the future <br>
‚ùé = No plan for support in the future <br>

2015 üü¢ <br>
2016 üü¢ <br>
2017 üü† <br>
2018 üü† <br>
2019 ‚ùé (As much as I'd like to say we'd fully support this year one day, the amount of telemetry, commercial crap, and bloatware - along with big crucial infrastructure changes which are hardly documented for the year just makes me lose faith in even getting a fraction of the gateway up to speed for this year) <br>
2020+ ‚ùé (NOTE: This is not planned for support due to being when Discord became a shell of its former self) <br>
